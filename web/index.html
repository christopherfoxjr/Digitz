<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheerpX - Digitz</title>
    <script src="https://cxrtnc.leaningtech.com/1.0.7/cx.js"></script>
    <script src="coi-serviceworker.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: monospace; background: #000; color: #0f0; height: 100vh; display: flex; flex-direction: column; }
        #status { text-align: center; padding: 20px; font-size: 14px; }
        #progress { width: 80%; max-width: 600px; height: 30px; border: 2px solid #0f0; margin: 20px auto; position: relative; }
        #bar { height: 100%; background: #0f0; width: 0%; transition: width 0.3s; }
        #pct { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #000; font-weight: bold; mix-blend-mode: difference; }
        #terminal { flex: 1; padding: 10px; overflow-y: auto; display: none; }
        #terminal.active { display: block; }
        .error { color: #f00; }
    </style>
</head>
<body>
    <div id="status">Initializing CheerpX VM...</div>
    <div id="progress"><div id="bar"></div><div id="pct">0%</div></div>
    <div id="terminal"></div>

    <script type="module">
        const status = document.getElementById('status');
        const bar = document.getElementById('bar');
        const pct = document.getElementById('pct');
        const terminal = document.getElementById('terminal');
        let cx;

        const log = (msg, err) => {
            status.innerHTML = msg;
            if (err) status.className = 'error';
            console.log(msg);
        };

        const progress = (p, msg) => {
            bar.style.width = p + '%';
            pct.textContent = Math.floor(p) + '%';
            if (msg) log(msg);
        };

        const loadDisk = async () => {
            const methods = [
                { t: 30000, fn: () => CheerpX.CloudDevice.create("wss://disks.webvm.io/debian_large_20230522_5044875331.ext2") },
                { t: 45000, fn: () => CheerpX.HttpBytesDevice.create("https://disks.webvm.io/debian_mini_20230519_5022088024.ext2") }
            ];
            
            for (const m of methods) {
                try {
                    return await Promise.race([m.fn(), new Promise((_, r) => setTimeout(() => r(new Error('timeout')), m.t))]);
                } catch (e) {
                    if (m === methods[methods.length - 1]) throw e;
                }
            }
        };

        const init = async () => {
            try {
                if (!window.crossOriginIsolated || typeof SharedArrayBuffer === 'undefined') {
                    log('Waiting for cross-origin isolation...');
                    for (let i = 0; i < 20; i++) {
                        await new Promise(r => setTimeout(r, 500));
                        if (window.crossOriginIsolated) break;
                    }
                    if (!window.crossOriginIsolated) throw new Error('Cross-origin isolation failed');
                }

                progress(10, 'Loading disk...');
                const idb = await CheerpX.IDBDevice.create("digitz");
                const disk = await loadDisk();
                progress(40, 'Creating filesystem...');
                const overlay = await CheerpX.OverlayDevice.create(disk, idb);
                const web = await CheerpX.WebDevice.create("");
                
                progress(60, 'Starting VM...');
                cx = await CheerpX.Linux.create({
                    mounts: [
                        { type: "ext2", path: "/", dev: overlay },
                        { type: "dir", path: "/app", dev: web },
                        { type: "devs", path: "/dev" }
                    ]
                });

                progress(70, 'Installing tools...');
                const env = ["HOME=/root", "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", "DEBIAN_FRONTEND=noninteractive"];
                await cx.run("/bin/bash", ["-c", "apt-get update && apt-get install -y git gcc make libncurses5-dev 2>&1 || true"], { env, cwd: "/root" });
                
                progress(85, 'Building Digitz...');
                await cx.run("/bin/bash", ["-c", "git clone https://github.com/christopherfoxjr/Digitz.git && cd Digitz && make && cp output/digitz /usr/local/bin/ 2>&1 || true"], { env, cwd: "/root" });

                progress(100, 'Ready!');
                await new Promise(r => setTimeout(r, 500));
                
                document.getElementById('status').style.display = 'none';
                document.getElementById('progress').style.display = 'none';
                terminal.classList.add('active');
                cx.setConsole(terminal);
                
                await cx.run("/bin/bash", ["--login"], {
                    env: ["HOME=/root", "USER=root", "SHELL=/bin/bash", "TERM=xterm-256color", "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
                    cwd: "/root",
                    uid: 0,
                    gid: 0
                });
            } catch (e) {
                log('ERROR: ' + e.message, true);
            }
        };

        setTimeout(init, 2000);
    </script>
</body>
</html>