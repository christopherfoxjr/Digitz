<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GravelBox - By WolfTech Innovations</title>
    <script src="https://cxrtnc.leaningtech.com/1.0.7/cx.js"></script>
    <script src="coi-serviceworker.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a0a;--bg2:#1a1a1a;--bg3:#2a2a2a;--txt:#fff;--txt2:#a0a0a0;--txt3:#707070;--border:#3a3a3a;--success:#0f0;--warn:#fa0;--error:#f00}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--txt);height:100vh;display:flex;flex-direction:column;overflow:hidden}
        #header{background:var(--bg2);border-bottom:1px solid var(--border);padding:1.25rem 2rem;display:flex;justify-content:space-between;align-items:center}
        .brand h1{font-size:1.75rem;font-weight:700;letter-spacing:-0.02em}
        .brand p{font-size:0.8rem;color:var(--txt2);margin-top:0.25rem}
        .controls{display:flex;gap:1rem}
        .btn{padding:0.625rem 1.25rem;border:1px solid var(--border);border-radius:0.375rem;font-size:0.875rem;font-weight:500;cursor:pointer;transition:all .2s;background:var(--bg3);color:var(--txt)}
        .btn:hover:not(:disabled){background:var(--bg2);border-color:var(--txt);transform:translateY(-1px)}
        .btn:disabled{opacity:0.4;cursor:not-allowed}
        .btn-primary{background:var(--txt);color:var(--bg);border-color:var(--txt)}
        .btn-primary:hover:not(:disabled){background:var(--txt2)}
        .container{flex:1;display:flex;flex-direction:column;padding:2rem;gap:1.5rem;overflow:hidden}
        .card{background:var(--bg2);border:1px solid var(--border);border-radius:0.5rem;padding:1.5rem}
        .card-header{font-size:0.875rem;font-weight:600;color:var(--txt2);margin-bottom:1rem;text-transform:uppercase;letter-spacing:0.1em}
        .status-text{font-size:1rem;font-weight:500;margin-bottom:1rem}
        .progress-container{position:relative;height:0.5rem;background:var(--bg3);border-radius:0.25rem;overflow:hidden}
        .progress-bar{height:100%;background:var(--txt);border-radius:0.25rem;transition:width .4s;position:relative}
        .progress-bar::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
        @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
        .progress-text{position:absolute;top:-1.5rem;right:0;font-size:0.75rem;font-weight:600;color:var(--txt2)}
        .console-output{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:0.375rem;padding:1rem;overflow-y:auto;font-family:'Courier New',monospace;font-size:0.8rem;line-height:1.6;min-height:0}
        .console-output::-webkit-scrollbar{width:0.5rem}
        .console-output::-webkit-scrollbar-track{background:var(--bg3)}
        .console-output::-webkit-scrollbar-thumb{background:var(--border);border-radius:0.25rem}
        .log-entry{margin-bottom:0.5rem;opacity:0;animation:fadeIn .2s forwards}
        @keyframes fadeIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
        .log-entry .ts{color:var(--txt3);margin-right:0.75rem}
        .log-entry.success{color:var(--success)}
        .log-entry.warning{color:var(--warn)}
        .log-entry.error{color:var(--error)}
        .log-entry.info{color:var(--txt2)}
        #terminal{display:none;flex:1;background:var(--bg);border:1px solid var(--border);border-radius:0.5rem;padding:1rem;overflow-y:auto;font-family:'Courier New',monospace;color:var(--txt);font-size:0.875rem}
        #terminal.active{display:block}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000}
        .modal.active{display:flex}
        .modal-content{background:var(--bg2);border:1px solid var(--border);border-radius:0.5rem;padding:2rem;max-width:500px;width:90%;animation:slideUp .3s}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{font-size:1.25rem;font-weight:600;margin-bottom:1.5rem}
        .modal-body{margin-bottom:1.5rem}
        .input-group{margin-bottom:1rem}
        .input-group label{display:block;font-size:0.875rem;font-weight:500;color:var(--txt2);margin-bottom:0.5rem}
        .input-group input{width:100%;padding:0.75rem;border:1px solid var(--border);border-radius:0.375rem;font-size:0.875rem;background:var(--bg3);color:var(--txt);transition:all .2s}
        .input-group input:focus{outline:none;border-color:var(--txt)}
        .modal-footer{display:flex;gap:0.75rem;justify-content:flex-end}
        .hidden{display:none!important}
        .msg{padding:1rem;border-radius:0.375rem;margin-bottom:1rem;border:1px solid;font-size:0.875rem}
        .msg.info{background:rgba(255,255,255,.05);border-color:var(--txt3);color:var(--txt2)}
        .msg.warn{background:rgba(255,170,0,.1);border-color:var(--warn);color:var(--warn)}
        input[type="file"]::file-selector-button{padding:0.5rem 1rem;border:1px solid var(--border);border-radius:0.375rem;background:var(--bg2);color:var(--txt);cursor:pointer;margin-right:0.75rem}
        @media (max-width:768px){#header{flex-direction:column;align-items:flex-start;gap:1rem}.controls{width:100%;flex-direction:column}.btn{width:100%;justify-content:center}}
    </style>
</head>
<body>
    <header id="header">
        <div class="brand"><h1>GravelBox</h1><p>By WolfTech Innovations</p></div>
        <div class="controls">
            <button class="btn" id="exportBtn" disabled>üíæ Export (.wolf)</button>
            <button class="btn" id="importBtn">üìÅ Import (.wolf)</button>
        </div>
    </header>
    <div class="container">
        <div class="card" id="statusCard">
            <div class="status-text" id="statusText">Initializing GravelBox...</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width:0%"></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>
        <div class="card" id="consoleCard" style="flex:1;display:flex;flex-direction:column">
            <div class="card-header">System Console</div>
            <div class="console-output" id="consoleOutput"></div>
        </div>
        <div id="terminal"></div>
    </div>
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">Export Workspace</div>
            <div class="modal-body">
                <div class="msg info">Exports entire VM state as a .wolf file for backup.</div>
                <div class="input-group"><label>Name</label><input type="text" id="exportName" placeholder="my-workspace"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelExport">Cancel</button>
                <button class="btn btn-primary" id="confirmExport">Export</button>
            </div>
        </div>
    </div>
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">Import Workspace</div>
            <div class="modal-body">
                <div class="msg warn">Warning: This replaces your current VM. Export first!</div>
                <div class="input-group"><label>Select .wolf File</label><input type="file" id="importFile" accept=".wolf"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelImport">Cancel</button>
                <button class="btn btn-primary" id="confirmImport">Import</button>
            </div>
        </div>
    </div>
    <script type="module">
        let el,cx,idb;const IDB="gravelbox";
        const $=(s)=>document.getElementById(s);
        const log=(m,t='info')=>{const e=document.createElement('div');e.className=`log-entry ${t}`;e.innerHTML=`<span class="ts">[${new Date().toLocaleTimeString()}]</span>${m}`;el.out.appendChild(e);el.out.scrollTop=el.out.scrollHeight};
        const prog=(p,m)=>{el.bar.style.width=`${p}%`;el.pct.textContent=`${Math.floor(p)}%`;if(m){el.stat.textContent=m;log(m,'info')}};
        const exportWS=async(n)=>{try{log('Exporting...','info');const db=await new Promise((r,j)=>{const q=indexedDB.open(IDB);q.onsuccess=()=>r(q.result);q.onerror=()=>j(q.error)});const tx=db.transaction(['blocks'],'readonly');const st=tx.objectStore('blocks');const d=await new Promise((r,j)=>{const q=st.getAll();q.onsuccess=()=>r(q.result);q.onerror=()=>j(q.error)});const exp={v:1,ts:new Date().toISOString(),name:n,data:d};const blob=new Blob([JSON.stringify(exp)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${n}.wolf`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);log(`Exported: ${n}.wolf (${(blob.size/1024/1024).toFixed(2)}MB)`,'success');db.close()}catch(e){log(`Export failed: ${e.message}`,'error')}};
        const importWS=async(f)=>{try{log('Importing...','info');const txt=await f.text();const imp=JSON.parse(txt);if(!imp.v||!imp.data)throw new Error('Invalid .wolf file');log(`Importing: ${imp.name}`,'info');const db=await new Promise((r,j)=>{const q=indexedDB.open(IDB);q.onsuccess=()=>r(q.result);q.onerror=()=>j(q.error)});const tx=db.transaction(['blocks'],'readwrite');const st=tx.objectStore('blocks');await new Promise((r,j)=>{const q=st.clear();q.onsuccess=()=>r();q.onerror=()=>j(q.error)});for(const i of imp.data)await new Promise((r,j)=>{const q=st.add(i);q.onsuccess=()=>r();q.onerror=()=>j(q.error)});db.close();log('Imported. Reloading...','success');setTimeout(()=>window.location.reload(),2000)}catch(e){log(`Import failed: ${e.message}`,'error')}};
        const runCmd=async(c,d)=>{log(d,'info');try{await cx.run("/bin/bash",["-c",c],{env:["HOME=/root","PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin","DEBIAN_FRONTEND=noninteractive"],cwd:"/root",uid:0,gid:0})}catch(e){log(`Failed: ${e.message}`,'warning')}};
        const loadDisk=async()=>{const m=[{n:'WebSocket',t:30000,f:()=>CheerpX.CloudDevice.create("wss://disks.webvm.io/debian_large_20230522_5044875331.ext2")},{n:'HTTP',t:45000,f:()=>CheerpX.HttpBytesDevice.create("https://disks.webvm.io/debian_mini_20230519_5022088024.ext2")}];for(const x of m){try{log(`Connecting via ${x.n}...`,'warning');const d=await Promise.race([x.f(),new Promise((_,j)=>setTimeout(()=>j(new Error('timeout')),x.t))]);log(`${x.n} connected`,'success');return d}catch(e){log(`${x.n} failed: ${e.message}`,'error');if(x===m[m.length-1])throw e}}};
        const init=async()=>{try{log('Starting GravelBox','success');if(!window.crossOriginIsolated||typeof SharedArrayBuffer==='undefined'){log('Waiting for isolation...','warning');for(let i=0;i<20;i++){await new Promise(r=>setTimeout(r,500));if(window.crossOriginIsolated)break}if(!window.crossOriginIsolated)throw new Error('Isolation failed')}log('Isolation OK','success');prog(10,'Loading disk...');log('Creating storage...','info');idb=await CheerpX.IDBDevice.create(IDB);log('Storage ready','success');const disk=await loadDisk();prog(40,'Building filesystem...');log('Building overlay...','info');const ovr=await CheerpX.OverlayDevice.create(disk,idb);log('Overlay ready','success');const web=await CheerpX.WebDevice.create("");prog(60,'Starting VM...');log('Booting VM...','info');cx=await CheerpX.Linux.create({mounts:[{type:"ext2",path:"/",dev:ovr},{type:"dir",path:"/app",dev:web},{type:"devs",path:"/dev"}]});log('VM started','success');const oc=cx.console;cx.console={write:d=>{const t=new TextDecoder().decode(d);if(t.trim())log(t.trim(),'info')}};await runCmd("curl https://github.com/WolfTech-Innovations/WolfEther/releases/download/Node_x64_RL1.7-LINUX/wolfether-node -o wolfether","Downloading WolfEther");prog(95,'Installing...');await runCmd("cp wolfether /usr/local/bin/wolfether && chmod +x /usr/local/bin/wolfether","Installing WolfEther");cx.console=oc;prog(100,'Ready');log('Launching WolfEther...','success');el.exp.disabled=false;await new Promise(r=>setTimeout(r,1500));el.stc.classList.add('hidden');el.con.classList.add('hidden');el.term.classList.add('active');cx.setConsole(el.term);await cx.run("/usr/local/bin/wolfether",[],{env:["HOME=/root","USER=root","SHELL=/bin/bash","PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],cwd:"/root",uid:0,gid:0})}catch(e){log(`Fatal: ${e.message}`,'error');prog(0,'Failed')}};
        document.addEventListener('DOMContentLoaded',()=>{el={stat:$('statusText'),bar:$('progressBar'),pct:$('progressText'),out:$('consoleOutput'),stc:$('statusCard'),con:$('consoleCard'),term:$('terminal'),exp:$('exportBtn'),imp:$('importBtn'),exM:$('exportModal'),imM:$('importModal'),exN:$('exportName'),imF:$('importFile')};el.exp.onclick=()=>el.exM.classList.add('active');el.imp.onclick=()=>el.imM.classList.add('active');$('cancelExport').onclick=()=>el.exM.classList.remove('active');$('cancelImport').onclick=()=>el.imM.classList.remove('active');$('confirmExport').onclick=async()=>{const n=el.exN.value.trim()||'workspace';el.exM.classList.remove('active');await exportWS(n)};$('confirmImport').onclick=async()=>{const f=el.imF.files[0];if(!f){log('Select a .wolf file','warning');return}el.imM.classList.remove('active');await importWS(f)};setTimeout(init,1000)});
    </script>
</body>
</html>