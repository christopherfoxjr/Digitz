<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigitzWeb Virtual Machine</title>
    <script src="https://cxrtnc.leaningtech.com/1.0.7/cx.js"></script>
    <script src="coi-serviceworker.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: monospace; background: #000; color: #0f0; height: 100vh; display: flex; flex-direction: column; }
        #header { text-align: center; padding: 15px; font-size: 18px; font-weight: bold; border-bottom: 2px solid #0f0; }
        #status { text-align: center; padding: 15px; font-size: 14px; }
        #progress { width: 80%; max-width: 600px; height: 30px; border: 2px solid #0f0; margin: 10px auto; position: relative; }
        #bar { height: 100%; background: #0f0; width: 0%; transition: width 0.3s; }
        #pct { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #000; font-weight: bold; mix-blend-mode: difference; }
        #console { width: 90%; max-width: 800px; height: 250px; margin: 10px auto; border: 1px solid #0f0; padding: 10px; overflow-y: auto; font-size: 12px; line-height: 1.5; }
        #terminal { flex: 1; padding: 10px; overflow-y: auto; display: none; }
        #terminal.active { display: block; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        .cmd-output { color: #888; margin-left: 20px; }
    </style>
</head>
<body>
    <div id="header">DigitzWeb Virtual Machine</div>
    <div id="status">Initializing...</div>
    <div id="progress"><div id="bar"></div><div id="pct">0%</div></div>
    <div id="console"></div>
    <div id="terminal"></div>

    <script type="module">
        const status = document.getElementById('status');
        const bar = document.getElementById('bar');
        const pct = document.getElementById('pct');
        const terminal = document.getElementById('terminal');
        const consoleEl = document.getElementById('console');
        let cx;

        const logConsole = (msg, type = '') => {
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        };

        const logCommand = (output) => {
            const lines = output.split('\n');
            lines.forEach(line => {
                if (line.trim()) {
                    const div = document.createElement('div');
                    div.className = 'cmd-output';
                    div.textContent = line;
                    consoleEl.appendChild(div);
                }
            });
            consoleEl.scrollTop = consoleEl.scrollHeight;
        };

        const log = (msg, err) => {
            status.innerHTML = msg;
            if (err) status.className = 'error';
            logConsole(msg, err ? 'error' : '');
        };

        const progress = (p, msg) => {
            bar.style.width = p + '%';
            pct.textContent = Math.floor(p) + '%';
            if (msg) log(msg);
        };

        const runCommand = async (cmd, desc) => {
            logConsole(desc);
            const env = ["HOME=/root", "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", "DEBIAN_FRONTEND=noninteractive"];
            
            let output = '';
            try {
                await cx.run("/bin/bash", ["-c", cmd + "; echo __EXIT_CODE__:$?"], { 
                    env, 
                    cwd: "/root"
                });
            } catch (e) {
                logConsole(`Command failed: ${e.message}`, 'warning');
            }
        };

        const loadDisk = async () => {
            const methods = [
                { name: 'WebSocket', t: 30000, fn: () => CheerpX.CloudDevice.create("wss://disks.webvm.io/debian_large_20230522_5044875331.ext2") },
                { name: 'HTTP', t: 45000, fn: () => CheerpX.HttpBytesDevice.create("https://disks.webvm.io/debian_mini_20230519_5022088024.ext2") }
            ];
            
            for (const m of methods) {
                try {
                    logConsole(`Trying ${m.name} disk loading (${m.t/1000}s timeout)...`, 'warning');
                    const disk = await Promise.race([m.fn(), new Promise((_, r) => setTimeout(() => r(new Error('timeout')), m.t))]);
                    logConsole(`${m.name} connected!`, 'success');
                    return disk;
                } catch (e) {
                    logConsole(`${m.name} failed: ${e.message}`, 'error');
                    if (m === methods[methods.length - 1]) throw e;
                }
            }
        };

        const init = async () => {
            try {
                logConsole('Starting initialization...', 'success');
                
                if (!window.crossOriginIsolated || typeof SharedArrayBuffer === 'undefined') {
                    logConsole('Waiting for cross-origin isolation...');
                    for (let i = 0; i < 20; i++) {
                        await new Promise(r => setTimeout(r, 500));
                        if (window.crossOriginIsolated) break;
                    }
                    if (!window.crossOriginIsolated) throw new Error('Cross-origin isolation failed');
                }
                logConsole('Cross-origin isolation OK', 'success');

                progress(10, 'Loading disk image...');
                logConsole('Creating IndexedDB storage...');
                const idb = await CheerpX.IDBDevice.create("digitz");
                logConsole('Storage created');
                
                const disk = await loadDisk();
                
                progress(40, 'Creating filesystem...');
                logConsole('Building overlay filesystem...');
                const overlay = await CheerpX.OverlayDevice.create(disk, idb);
                logConsole('Overlay filesystem ready', 'success');
                
                const web = await CheerpX.WebDevice.create("");
                
                progress(60, 'Starting VM...');
                logConsole('Booting Linux VM...');
                cx = await CheerpX.Linux.create({
                    mounts: [
                        { type: "ext2", path: "/", dev: overlay },
                        { type: "dir", path: "/app", dev: web },
                        { type: "devs", path: "/dev" }
                    ]
                });
                logConsole('VM started!', 'success');

                progress(70, 'Installing tools...');
                
                // Redirect stdout/stderr to console temporarily
                const originalConsole = cx.console;
                cx.console = {
                    write: (data) => {
                        const text = new TextDecoder().decode(data);
                        if (text.trim()) logCommand(text);
                    }
                };
                
                await runCommand("apt-get update", "Running apt-get update...");
                
                progress(75, 'Installing packages...');
                await runCommand("apt-get install -y git gcc make libncurses5-dev python3 python3-pip", "Installing git, gcc, make, ncurses, python3...");
                
                progress(85, 'Building Digitz...');
                await runCommand("git clone https://github.com/christopherfoxjr/Digitz", "Cloning Digitz repository...");
                
                progress(90, 'Compiling...');
                await runCommand("cd Digitz && make", "Compiling with make...");
                
                progress(95, 'Installing...');
                await runCommand("cd Digitz && cp output/digitz /usr/local/bin/digitz && chmod +x /usr/local/bin/digitz", "Installing Digitz binary...");
                
                // Restore console
                cx.console = originalConsole;

                progress(100, 'Ready!');
                logConsole('Setup complete! Launching Digitz...', 'success');
                await new Promise(r => setTimeout(r, 1000));
                
                document.getElementById('header').style.display = 'none';
                document.getElementById('status').style.display = 'none';
                document.getElementById('progress').style.display = 'none';
                consoleEl.style.display = 'none';
                terminal.classList.add('active');
                cx.setConsole(terminal);
                
                // Run Digitz directly
                await cx.run("/usr/local/bin/digitz", [], {
                    env: ["HOME=/root", "USER=root", "SHELL=/bin/bash", "TERM=xterm-256color", "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
                    cwd: "/root",
                    uid: 0,
                    gid: 0
                });
            } catch (e) {
                log('ERROR: ' + e.message, true);
                logConsole('Fatal error: ' + e.message, 'error');
            }
        };

        setTimeout(init, 2000);
    </script>
</body>
</html>